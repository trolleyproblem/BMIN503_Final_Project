---
title: "Deep Learning for Spirometry"
subtitle: "BMIN503/EPID600 Final Project"
author: "Emily Moin"
format: html
editor: visual
number-sections: true
embed-resources: true
---

------------------------------------------------------------------------

Use this template to complete your project throughout the course. Your Final Project presentation will be based on the contents of this document. Replace the title/name above and text below with your own, but keep the headers. Feel free to change the theme and other display settings, although this is not required.

## Overview {#sec-overview}

Give a brief a description of your project and its goal(s), what data you are using to complete it, and what two faculty/staff in different fields you have spoken to about your project with a brief summary of what you learned from each person. Include a link to your final project GitHub repository.

## Introduction {#sec-introduction}

Describe the problem addressed, its significance, and some background to motivate the problem. This should extend what is in the @sec-overview.

Explain why your problem is interdisciplinary, what fields can contribute to its understanding, and incorporate background related to what you learned from meeting with faculty/staff.

## Methods {#sec-methods}

Describe the data used and general methodological approach used to address the problem described in the @sec-introduction. Subsequently, incorporate full R code necessary to retrieve and clean data, and perform analysis. Be sure to include a description of code so that others (including your future self) can understand what you are doing and why.

```{r Load libraries and set seed}
#| output: false
library(tidyverse)
library(haven)
library(rspiro)
library(here)

set.seed(36)
```

```{r Load spirometry data}
spirometry1 <- read_sas(here::here("data/spxraw_e.sas7bdat"))
spirometry2 <- read_sas(here::here("data/spxraw_f.sas7bdat"))
spirometry3 <- read_sas(here::here("data/spxraw_g.sas7bdat"))

all_spirometry <- bind_rows(spirometry1, spirometry2, spirometry3)
rm(spirometry1,spirometry2,spirometry3)

all_spirometry <- all_spirometry %>% rename(seqn = SEQN)
```

```{r Load body measurement data}
bm1 <- read_xpt(here::here("data/BMX_E.XPT")) %>% select(SEQN, BMXWT, BMXHT)
bm2 <- read_xpt(here::here("data/BMX_F.XPT")) %>% select(SEQN, BMXWT, BMXHT)
bm3 <- read_xpt(here::here("data/BMX_G.XPT")) %>% select(SEQN, BMXWT, BMXHT)

all_bm <- bind_rows(bm1, bm2, bm3)
rm(bm1, bm2, bm3)

all_bm <- all_bm %>%
  rename(seqn = SEQN,
         wt = BMXWT,
         ht = BMXHT)
```

```{r Load mortality data}
mort1 <- read_fwf(file=here::here("data/NHANES_2007_2008_MORT_2019_PUBLIC.dat"),
                col_types = "iiiiiiii",
                fwf_cols(seqn = c(1,6),
                         eligstat = c(15,15),
                         mortstat = c(16,16),
                         ucod_leading = c(17,19),
                         diabetes = c(20,20),
                         hyperten = c(21,21),
                         permth_int = c(43,45),
                         permth_exm = c(46,48)
                ),
                na = c("", ".")
)

mort2 <- read_fwf(file=here::here("data/NHANES_2009_2010_MORT_2019_PUBLIC.dat"),
                  col_types = "iiiiiiii",
                  fwf_cols(seqn = c(1,6),
                           eligstat = c(15,15),
                           mortstat = c(16,16),
                           ucod_leading = c(17,19),
                           diabetes = c(20,20),
                           hyperten = c(21,21),
                           permth_int = c(43,45),
                           permth_exm = c(46,48)
                  ),
                  na = c("", ".")
)

mort3 <- read_fwf(file=here::here("data/NHANES_2011_2012_MORT_2019_PUBLIC.dat"),
                  col_types = "iiiiiiii",
                  fwf_cols(seqn = c(1,6),
                           eligstat = c(15,15),
                           mortstat = c(16,16),
                           ucod_leading = c(17,19),
                           diabetes = c(20,20),
                           hyperten = c(21,21),
                           permth_int = c(43,45),
                           permth_exm = c(46,48)
                  ),
                  na = c("", ".")
)

all_mortality <- bind_rows(mort1, mort2, mort3)
rm(mort1, mort2, mort3)
```

```{r Load demographic data}
demo1 <- read_xpt(here::here("data/DEMO_E.XPT"))
demo2 <- read_xpt(here::here("data/DEMO_F.XPT"))
demo3 <- read_xpt(here::here("data/DEMO_G.XPT"))

# The demographic variables are different across NHANES years
# so for now I will create a subset with only variables of interest to me

demo1 <- demo1 %>% select(SEQN, RIDAGEEX, RIDRETH1, RIAGENDR)
demo2 <- demo2 %>% select(SEQN, RIDAGEEX, RIDRETH1, RIAGENDR)
demo3 <- demo3 %>% select(SEQN, RIDEXAGM, RIDRETH1, RIAGENDR) %>%
  rename(RIDAGEEX = RIDEXAGM)

all_demo <- bind_rows(demo1, demo2, demo3)
rm(demo1, demo2, demo3)

all_demo <-
  all_demo %>% rename(
  seqn = SEQN,
  age_months = RIDAGEEX,
  gender = RIAGENDR,
  race = RIDRETH1
)

all_demo <- all_demo %>%
  mutate(age_years = age_months/12,
         gender = factor(gender),
         race = factor(race))

```

```{r Load PFT measurements}
pft1 <- read_xpt(here::here("data/SPX_E.xpt"))
pft2 <- read_xpt(here::here("data/SPX_F.xpt"))
pft3 <- read_xpt(here::here("data/SPX_G.xpt"))

all_pft <- bind_rows(pft1, pft2, pft3)
rm(pft1, pft2, pft3)

all_pft <- all_pft %>% rename(seqn = SEQN)
```

```{r Join tables for further data cleaning}

all_spirometry <- 
  all_spirometry %>%
  left_join(all_demo, by = "seqn") %>%
  filter(age_years >= 18)

```

## Results {#sec-results}

Describe your results and include relevant tables, plots, and code/comments used to obtain them. You may refer to the @sec-methods as needed. End with a brief conclusion of your findings related to the question you set out to address. You can include references if you'd like, but this is not required.

## Conclusion

This the conclusion. The @sec-results can be invoked here.
